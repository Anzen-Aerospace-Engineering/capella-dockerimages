#!/usr/bin/env bash
# SPDX-FileCopyrightText: Copyright DB InfraGO AG and contributors
# SPDX-License-Identifier: Apache-2.0

set -eo pipefail

cat >> "${CNB_OUTPUT_DIR}/run.Dockerfile" <<EOL
ARG base_image
FROM \${base_image}
USER root

RUN apt-get update && \
    apt-get upgrade --yes && \
    apt-get install --yes --no-install-recommends \
        gettext-base \
        locales \
        python3 \
        python3-pip \
        python3-venv \
        git-lfs \
        unzip \
        neovim \
        zip \
        wget && \
    rm -rf /var/lib/apt/lists/*

RUN echo "en_GB.UTF-8 UTF-8" >> /etc/locale.gen && \
    locale-gen en_GB.UTF-8 && \
    update-locale en_GB.UTF-8 && \
    dpkg-reconfigure --frontend=noninteractive locales && \
    echo "LANG=en_GB.UTF-8" >> /etc/default/locale && \
    echo "LANGUAGE=en_GB:en" >> /etc/default/locale && \
    echo "LC_ALL=en_GB.UTF-8" >> /etc/default/locale
ENV LANG="en_GB.UTF-8"
ENV LANGUAGE="en_GB:en"
ENV LC_ALL="en_GB.UTF-8"

RUN ln -s "\$(which python3.11)" /usr/bin/python && \
    ln -sf "\$(which python3.11)" /usr/bin/python3 && \
    ln -sf "\$(which pip3.11)" /usr/local/bin/pip && \
    ln -sf "\$(which pip3.11)" /usr/local/bin/pip3 && \
    git config --global core.hooksPath /layers/pre-commit/hooks

ENV WORKSPACE_DIR=/workspace

ARG user_id
USER \${user_id}
EOL
